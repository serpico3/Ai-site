name: Generate Article & Instagram Post

on:
  schedule:
    - cron: '0 15 * * *'  # Ogni giorno alle 15:00 UTC (16:00 CET)
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install dependencies
        run: |
          pip install groq requests pillow

      - name: ðŸ” Debug Environment
        run: |
          echo "=== Environment Debug ==="
          echo "âœ… GROQ_API_KEY: ${GROQ_API_KEY:0:10}..."
          echo "âœ… INSTAGRAM_ACCESS_TOKEN: ${INSTAGRAM_ACCESS_TOKEN:0:10}..."
          echo "âœ… INSTAGRAM_BUSINESS_ACCOUNT_ID: ${INSTAGRAM_BUSINESS_ACCOUNT_ID}"
          echo "================================"

      - name: ðŸ“ Generate Article
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          echo "ðŸš€ Starting article generation..."
          python scripts/generate_article.py
          echo "âœ… Article generation completed"

      - name: ðŸ“¸ Generate Instagram Post
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          INSTAGRAM_ACCESS_TOKEN: ${{ secrets.INSTAGRAM_ACCESS_TOKEN }}
          INSTAGRAM_BUSINESS_ACCOUNT_ID: ${{ secrets.INSTAGRAM_BUSINESS_ACCOUNT_ID }}
        run: |
          echo "ðŸš€ Starting Instagram post generation..."
          python scripts/generate_instagram.py
          echo "âœ… Instagram generation completed"
        continue-on-error: true

      - name: ðŸ“ List generated files
        run: |
          echo "=== Files Generated ==="
          ls -lah docs/instagram/ 2>/dev/null | head -10 || echo "No image files found"
          ls -lah articles/ 2>/dev/null | head -5 || echo "No articles found"
          echo "========================"

      - name: ðŸ”„ Configure Git
        run: |
          git config user.name "Diego Bot"
          git config user.email "diego@bot.local"

      - name: ðŸ’¾ Commit changes
        run: |
          echo "=== Committing changes ==="
          git add -A
          git status
          git commit -m "ðŸ¤– Auto-generated: article + instagram post $(date +%Y-%m-%d)" --allow-empty || echo "Nothing to commit"
          echo "========================"

      - name: ðŸš€ Push to repository
        run: |
          echo "=== Pushing to GitHub ==="
          git push origin main
          echo "Push completed successfully!"
          echo "========================"

      - name: âœ… Job Summary
        if: always()
        run: |
          echo "=== WORKFLOW SUMMARY ==="
          echo "Article: Generated âœ…"
          echo "Instagram: Published or saved for backup"
          echo "Commit: Done âœ…"
          echo "Push: Done âœ…"
          echo "Images: Available at https://serpico3.github.io/Ai-site/instagram/"
          echo "========================"
